# ==============================================================================
# Ingress - NGINX Ingress Controller (대안)
# ==============================================================================
#
# NGINX Ingress Controller 필요:
# https://kubernetes.github.io/ingress-nginx/deploy/
#
# 설치 방법:
#   helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
#   helm install ingress-nginx ingress-nginx/ingress-nginx \
#     -n ingress-nginx --create-namespace \
#     --set controller.service.annotations."service\.beta\.kubernetes\.io/aws-load-balancer-type"="nlb"
#
# TLS 인증서 옵션:
#   1. cert-manager 사용 (Let's Encrypt 자동 발급)
#   2. 수동으로 Secret 생성
#
# ==============================================================================

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: label-studio
  namespace: label-studio
  annotations:
    # NGINX Ingress Controller 설정
    kubernetes.io/ingress.class: nginx

    # SSL/TLS 설정
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # 타임아웃 설정 (SSO 세션 유지)
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"

    # 바디 사이즈 제한 (파일 업로드)
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"

    # Sticky Session (세션 어피니티)
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/session-cookie-name: "route"
    nginx.ingress.kubernetes.io/session-cookie-expires: "10800"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "10800"

    # cert-manager 사용 시 (Let's Encrypt 자동 발급)
    # 아래 주석을 해제하고 ClusterIssuer를 생성해야 합니다
    # cert-manager.io/cluster-issuer: letsencrypt-prod

spec:
  rules:
    - host: label.hatiolab.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: label-studio
                port:
                  number: 8080

  # TLS 설정
  tls:
    - hosts:
        - label.hatiolab.com
      # cert-manager 사용 시 자동 생성됨
      secretName: label-studio-tls

---
# ==============================================================================
# ClusterIssuer - cert-manager (Let's Encrypt)
# ==============================================================================
#
# cert-manager가 설치되어 있어야 합니다:
# https://cert-manager.io/docs/installation/
#
# 설치 방법:
#   kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml
#
# ==============================================================================

# apiVersion: cert-manager.io/v1
# kind: ClusterIssuer
# metadata:
#   name: letsencrypt-prod
# spec:
#   acme:
#     # Let's Encrypt 프로덕션 서버
#     server: https://acme-v02.api.letsencrypt.org/directory
#     # 이메일 주소 (인증서 만료 알림)
#     email: admin@hatiolab.com
#     privateKeySecretRef:
#       name: letsencrypt-prod
#     solvers:
#       - http01:
#           ingress:
#             class: nginx
